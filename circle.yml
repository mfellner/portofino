machine:

  services:
    - docker
  environment:
    HTPASSWD_USER: docker
    HTPASSWD_PASS: secret

dependencies:
  override:
    - docker build -t $REGISTRY_NAME ./registry:
        environment:
          REGISTRY_NAME: $DOCKER_USER/portofino
    - docker build -t $NGINX_NAME ./nginx:
        environment:
          NGINX_NAME: $DOCKER_USER/portofino-proxy

test:
  override:
    - bash portofino.sh start -y; sleep 4:
        environment:
          REGISTRY_NAME: $DOCKER_USER/portofino
          NGINX_NAME: $DOCKER_USER/portofino-proxy
          SSL_COUNTRY: DE
          SSL_STATE: Berlin
          SSL_LOCATION: Berlin
          SSL_ORGANISATION: Portofino
          SSL_ORGANISATION_UNIT: Portofino
          SSL_COMMON_NAME: localhost
    - curl --retry 2 --retry-delay 4 -ku $HTPASSWD_USER:$HTPASSWD_PASS https://localhost:5000/v2/

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push circleci/elasticsearch
